name: validate-renovate
on:
  workflow_dispatch:
  push:
jobs:
  validate-renovate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - env:
          LOG_LEVEL: debug
        run: |
          docker run --rm -i -v $(pwd):$(pwd) -w $(pwd) -e LOG_LEVEL \
            renovate/renovate:slim renovate-config-validator
      - env:
          RENOVATE_TOKEN: ${{ secrets.CR_PAT }}
          LOG_LEVEL: debug
          LOG_FORMAT: json
        run: |
          docker run --rm -i -v $(pwd):$(pwd) -w $(pwd) -e LOG_LEVEL -e LOG_FORMAT -e RENOVATE_TOKEN \
            renovate/renovate:slim ${{ github.repository }} --dry-run | tee renovate.jsonl
          if grep fail renovate.jsonl; then
            echo "::error ::$(grep fail renovate.jsonl| jq -r .msg)"
            exit 1
          fi